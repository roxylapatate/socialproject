<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ—Å–ú–µ—Ç—Ä–æ –ü–æ–º–æ—â–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API —Å –º–æ–¥—É–ª—è–º–∏ –ø–æ–∏—Å–∫–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=8e8319a0-f355-4f5b-bef4-20745b37f5a1&lang=ru_RU" type="text/javascript"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç Roboto –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --moscow-red: #E31E24; /* –¶–≤–µ—Ç –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ */
            --bg-color: #ffffff;
            --text-color: #000000;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¢–µ–ª–µ–≥—Ä–∞–º) */
        body.dark-mode {
            --bg-color: #1c1c1e;
            --text-color: #ffffff;
        }

        body, html { 
            padding: 0; margin: 0; width: 100%; height: 100%; 
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
        }

        #map { width: 100%; height: 100%; }

        /* –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls-panel {
            position: absolute;
            bottom: 30px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç—É */
        }

        .btn-row {
            display: flex;
            gap: 10px;
            pointer-events: auto;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ */
        .action-btn {
            flex: 1;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: none;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            white-space: nowrap;
        }

        .action-btn:active { transform: scale(0.96); }
        
        .btn-primary {
            background-color: var(--moscow-red);
            color: white;
            font-weight: 700;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        #loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            display: block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –ú–æ—Å–∫–≤—ã...</div>
    <div id="map"></div>

    <div class="controls-panel">
        <!-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ -->
        <div class="btn-row">
            <button class="action-btn" onclick="searchNear('–ú–§–¶')">üè¢ –ú–§–¶</button>
            <button class="action-btn" onclick="searchNear('–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞')">üè• –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏</button>
            <button class="action-btn" onclick="searchNear('–ê–ø—Ç–µ–∫–∞')">üíä –ê–ø—Ç–µ–∫–∏</button>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="btn-row">
            <button class="action-btn" onclick="findMe()">üìç –ì–¥–µ —è?</button>
            <button id="send-btn" class="action-btn btn-primary" style="display:none;" onclick="sendRoute()">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        </div>
    </div>

    <script type="text/javascript">
        let tg = window.Telegram.WebApp;
        tg.expand(); 
        
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-mode');
        }

        let myMap;
        let routePanelControl;
        let currentRouteLength = "";
        let currentRouteTime = "";

        ymaps.ready(init);

        function init() {
            document.getElementById('loader').style.display = 'none';

            myMap = new ymaps.Map("map", {
                center: [55.753215, 37.622504], // –¶–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã
                zoom: 11,
                controls: ['zoomControl'] // –¢–æ–ª—å–∫–æ –∑—É–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ö–ª–∞–º–ª—è—Ç—å
            }, {
                searchControlProvider: 'yandex#search'
            });

            routePanelControl = new ymaps.control.RoutePanel({
                options: {
                    showHeader: true,
                    title: '–ú–∞—Ä—à—Ä—É—Ç',
                    autofocus: false,
                    maxWidth: '90%' // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å
                }
            });

            routePanelControl.routePanel.state.set({
                type: 'masstransit',
                fromEnabled: true,
                toEnabled: true
            });

            myMap.controls.add(routePanelControl, {float: 'top'});

            routePanelControl.routePanel.getRouteAsync().then(function (route) {
                route.model.events.add('requestsuccess', function () {
                    var activeRoute = route.getActiveRoute();
                    if (activeRoute) {
                        currentRouteLength = activeRoute.properties.get("distance").text;
                        currentRouteTime = activeRoute.properties.get("duration").text;
                        
                        document.getElementById('send-btn').style.display = 'flex';
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                });
            });
        }

        function findMe() {
            ymaps.geolocation.get({
                provider: 'browser',
                mapStateAutoApply: true
            }).then(function (result) {
                routePanelControl.routePanel.state.set({
                    from: result.geoObjects.get(0).geometry.getCoordinates(),
                    fromDisplayName: '–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
                });
            });
        }

        function searchNear(query) {
            let center = myMap.getCenter();
            
            let to = routePanelControl.routePanel.state.get('to');
            if(to) {
            }

            var searchControl = new ymaps.control.SearchControl({
                options: {
                    provider: 'yandex#search',
                    noPlacemark: false,
                    results: 5 // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5
                }
            });
            
            myMap.controls.add(searchControl);
            searchControl.search(query);
            tg.HapticFeedback.impactOccurred('light');
        }

        function sendRoute() {
            if (!currentRouteTime) return;

            // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –æ–±—ä–µ–∫—Ç
            const data = JSON.stringify({
                time: currentRouteTime,
                distance: currentRouteLength,
                action: "save_route"
            });
            
            tg.sendData(data);
        }
    </script>
</body>
</html>