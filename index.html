<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Route Selection</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ü–†–û–í–ï–†–¨–¢–ï API –ö–õ–Æ–ß -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=8e8319a0-f355-4f5b-bef4-20745b37f5a1&lang=ru_RU&modules=services.Panel,suggest,multiRouter.MultiRoute,geolocation" type="text/javascript"></script>
    
    <style>
        /* --- APPLE DESIGN SYSTEM --- */
        :root {
            --bg-color: #ffffff;
            --secondary-bg: #F2F2F7;
            --blue: #007AFF;
            --text-main: #000000;
            --text-sec: #8E8E93;
            --radius: 16px;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fff; }

        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        .sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            padding: 20px 16px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            box-shadow: 0 -5px 40px rgba(0,0,0,0.15);
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 80vh; /* –ß—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –Ω–µ —É–ª–µ—Ç–∞–ª –≤ –Ω–µ–±–æ */
            display: flex; flex-direction: column;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .search-box {
            display: flex; flex-direction: column; gap: 10px;
        }
        .input-wrap {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 0 12px;
            height: 44px;
            display: flex; align-items: center;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 12px; }
        .green { background: #34C759; }
        .red { background: #FF3B30; }
        
        input { border: none; background: transparent; width: 100%; font-size: 17px; outline: none; }
        
        .main-btn {
            background: var(--blue); color: white; border: none;
            width: 100%; padding: 14px; border-radius: 12px;
            font-size: 17px; font-weight: 600; margin-top: 16px;
            cursor: pointer; transition: 0.2s;
        }
        .main-btn:active { transform: scale(0.98); }

        /* --- –°–ü–ò–°–û–ö –ú–ê–†–®–†–£–¢–û–í (–°–ö–†–´–¢ –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ) --- */
        .routes-list {
            display: none; /* Flex when active */
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            overflow-y: auto; /* –°–∫—Ä–æ–ª–ª –µ—Å–ª–∏ –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ */
            max-height: 40vh;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–¥–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-card {
            background: var(--secondary-bg);
            padding: 14px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }

        /* –ê–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ (–≤—ã–±—Ä–∞–Ω–Ω–∞—è) */
        .route-card.selected {
            background: #fff;
            border-color: var(--blue);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
        }

        .route-info h3 { margin: 0; font-size: 20px; font-weight: 700; color: var(--text-main); }
        .route-info p { margin: 4px 0 0 0; font-size: 14px; color: var(--text-sec); }
        
        .route-tag {
            background: rgba(142, 142, 147, 0.15);
            padding: 4px 8px; border-radius: 6px;
            font-size: 13px; color: var(--text-main); font-weight: 500;
        }
        .route-card.selected .route-tag {
            background: var(--blue); color: white;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ */
        #confirm-btn { display: none; background: #000; }

        /* –•–∞–∫ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ (—á—Ç–æ–±—ã –±—ã–ª–∏ –ø–æ–≤–µ—Ä—Ö –ø–∞–Ω–µ–ª–∏) */
        .ymaps-2-1-79-search__suggest { z-index: 99999 !important; border-radius: 12px !important; border:none !important; box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important; top: -200px !important; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="sheet">
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ -->
        <div class="routes-list" id="routes-container">
            <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        </div>

        <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ -->
        <div class="search-box" id="search-ui">
            <div class="input-wrap">
                <div class="dot green"></div>
                <input type="text" id="suggest-from" placeholder="–û—Ç–∫—É–¥–∞?">
            </div>
            <div class="input-wrap">
                <div class="dot red"></div>
                <input type="text" id="suggest-to" placeholder="–ö—É–¥–∞?">
            </div>
            <button class="main-btn" onclick="buildRoute()">–ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç—ã</button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–µ—Ö–∞–ª–∏" –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ -->
        <button class="main-btn" id="confirm-btn" onclick="sendData()">–ü–æ–µ—Ö–∞–ª–∏ üöÄ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let myMap, multiRoute;
        let foundRoutes = []; // –°—é–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        let selectedIndex = 0; // –ö–∞–∫–æ–π –≤—ã–±—Ä–∞–Ω —Å–µ–π—á–∞—Å

        ymaps.ready(init);

        function init() {
            myMap = new ymaps.Map('map', {
                center: [55.753215, 37.622504], zoom: 11, controls: []
            });
            // –°–∞–¥–∂–µ—Å—Ç—ã
            new ymaps.SuggestView('suggest-from', { results: 3, offset: [0, -10] });
            new ymaps.SuggestView('suggest-to', { results: 3, offset: [0, -10] });
        }

        function buildRoute() {
            const from = document.getElementById('suggest-from').value;
            const to = document.getElementById('suggest-to').value;
            if(!from || !to) return tg.HapticFeedback.notificationOccurred('error');

            if(multiRoute) myMap.geoObjects.remove(multiRoute);

            // –°–æ–∑–¥–∞–µ–º –º—É–ª—å—Ç–∏–º–∞—Ä—à—Ä—É—Ç
            multiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [from, to],
                params: { routingMode: 'masstransit' } // –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
            }, {
                // –°—Ç–∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
                routeActiveStrokeColor: "#007AFF", 
                routeActiveStrokeWidth: 6,
                // –°—Ç–∏–ª–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö) –º–∞—Ä—à—Ä—É—Ç–æ–≤ - —Å–µ—Ä—ã–µ
                routeStrokeColor: "#b0b0b0",
                routeStrokeWidth: 4,
                boundsAutoApply: true
            });

            myMap.geoObjects.add(multiRoute);

            // –°–ª—É—à–∞–µ–º, –∫–æ–≥–¥–∞ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∞–π–¥—É—Ç—Å—è
            multiRoute.model.events.add('requestsuccess', function() {
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
                const routes = multiRoute.model.getRoutes();
                foundRoutes = routes;

                if (routes.length > 0) {
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    document.getElementById('search-ui').style.display = 'none';
                    document.getElementById('routes-container').style.display = 'flex';
                    document.getElementById('confirm-btn').style.display = 'block';

                    renderRoutesList(routes);
                    tg.HapticFeedback.notificationOccurred('success');
                }
            });
            
            multiRoute.model.events.add('requestfail', function() {
                alert("–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
        function renderRoutesList(routes) {
            const container = document.getElementById('routes-container');
            container.innerHTML = ""; // –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä–æ–µ

            routes.forEach((route, index) => {
                // –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞
                const time = route.properties.get("duration").text;
                const dist = route.properties.get("distance").text;
                
                // –°–æ–∑–¥–∞–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫—É
                const card = document.createElement('div');
                card.className = `route-card ${index === 0 ? 'selected' : ''}`; // –ü–µ—Ä–≤—ã–π –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                card.onclick = () => selectRoute(index); // –ü—Ä–∏ –∫–ª–∏–∫–µ –≤—ã–±–∏—Ä–∞–µ–º —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç
                
                card.innerHTML = `
                    <div class="route-info">
                        <h3>${time}</h3>
                        <p>${dist} ‚Ä¢ –í–∞—Ä–∏–∞–Ω—Ç ${index + 1}</p>
                    </div>
                    <div class="route-tag">${index === 0 ? '–ë—ã—Å—Ç—Ä—ã–π' : '–ê–ª—å—Ç–µ—Ä–Ω.'}</div>
                `;
                
                container.appendChild(card);
            });
            
            selectedIndex = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –Ω–∞ –ø–µ—Ä–≤—ã–π
        }

        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        function selectRoute(index) {
            // 1. –ì–æ–≤–æ—Ä–∏–º –∫–∞—Ä—Ç–µ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç
            multiRoute.setActiveRoute(index);
            selectedIndex = index;

            // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ (–±–µ–ª–∞—è —Ä–∞–º–∫–∞)
            const cards = document.querySelectorAll('.route-card');
            cards.forEach((card, i) => {
                if (i === index) card.classList.add('selected');
                else card.classList.remove('selected');
            });

            tg.HapticFeedback.impactOccurred('light');
        }

        function sendData() {
            if (foundRoutes.length === 0) return;
            
            // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
            const route = foundRoutes[selectedIndex];
            const data = {
                time: route.properties.get("duration").text,
                dist: route.properties.get("distance").text,
                action: 'save_route'
            };
            
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>
