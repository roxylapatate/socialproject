<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Metro Nav V10</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ö–õ–Æ–ß -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=8e8319a0-f355-4f5b-bef4-20745b37f5a1&lang=ru_RU&modules=services.Panel,multiRouter.MultiRoute,geolocation" type="text/javascript"></script>
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fff; }

        /* –ò–ù–î–ò–ö–ê–¢–û–† –í–ï–†–°–ò–ò - –ß–¢–û–ë–´ –ü–û–ù–Ø–¢–¨, –û–ë–ù–û–í–ò–õ–°–Ø –õ–ò –ö–≠–® */
        .debug-bar {
            position: absolute; top: 0; left: 0; right: 0;
            background: #FF0000; color: white; font-weight: bold;
            text-align: center; padding: 5px; z-index: 99999; font-size: 12px;
        }

        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }

        /* –ü–ê–ù–ï–õ–¨ */
        .sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: #fff; border-radius: 20px 20px 0 0;
            padding: 20px; padding-bottom: 40px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
            z-index: 100; display: flex; flex-direction: column; gap: 10px;
            transition: transform 0.3s ease;
            max-height: 80vh;
        }

        /* –ü–û–õ–Ø –í–í–û–î–ê */
        .input-row {
            background: #F2F2F7; border-radius: 10px; height: 50px;
            display: flex; align-items: center; padding: 0 12px;
            margin-bottom: 8px; border: 1px solid #ddd;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .g { background: #34C759; } .r { background: #FF3B30; }
        
        input { width: 100%; height: 100%; border: none; background: transparent; font-size: 16px; outline: none; }

        /* –°–ü–ò–°–û–ö –ü–û–î–°–ö–ê–ó–û–ö (–ü–û–í–ï–†–• –í–°–ï–ì–û) */
        .suggestions-list {
            position: absolute; bottom: 100%; left: 0; right: 0;
            background: white; border-top: 1px solid #ccc;
            max-height: 250px; overflow-y: auto; z-index: 200;
            display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .suggestions-list.active { display: block; }
        .s-item { padding: 15px; border-bottom: 1px solid #eee; font-size: 16px; }
        .s-item:active { background: #eee; }

        /* –ö–ù–û–ü–ö–ê */
        .btn {
            background: #007AFF; color: white; width: 100%; padding: 16px;
            border-radius: 12px; border: none; font-size: 16px; font-weight: bold;
        }

        /* –†–ï–ó–£–õ–¨–¢–ê–¢–´ */
        .results-view { display: none; flex-direction: column; height: 100%; }
        
        /* –¢–∞–±—ã */
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .tab {
            background: #eee; padding: 10px 20px; border-radius: 20px;
            white-space: nowrap; border: 2px solid transparent;
        }
        .tab.active { background: #fff; border-color: #007AFF; color: #007AFF; }

        .steps-list { flex: 1; overflow-y: auto; margin-top: 10px; }
        .step { padding: 10px 0; border-bottom: 1px solid #eee; }

    </style>
</head>
<body>

    <!-- –ï–°–õ–ò –í–´ –ù–ï –í–ò–î–ò–¢–ï –≠–¢–£ –ü–û–õ–û–°–£ - –ó–ù–ê–ß–ò–¢ –£ –í–ê–° –°–¢–ê–†–´–ô –ö–≠–® -->
    <div class="debug-bar">–í–ï–†–°–ò–Ø V10 (DEBUG)</div>

    <div id="map"></div>

    <div class="sheet">
        <!-- –°–ü–ò–°–û–ö –ü–û–î–°–ö–ê–ó–û–ö -->
        <div class="suggestions-list" id="s-list"></div>

        <!-- –ü–û–ò–°–ö -->
        <div id="view-search">
            <div class="input-row">
                <div class="dot g"></div>
                <input type="text" id="inp-from" placeholder="–û—Ç–∫—É–¥–∞?" autocomplete="off">
            </div>
            <div class="input-row">
                <div class="dot r"></div>
                <input type="text" id="inp-to" placeholder="–ö—É–¥–∞?" autocomplete="off">
            </div>
            <button class="btn" onclick="runSearch()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        </div>

        <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
        <div id="view-results" class="results-view">
            <div class="tabs" id="tabs"></div>
            <div class="steps-list" id="steps"></div>
            <button class="btn" style="background:black; margin-top:10px;" onclick="sendTg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
            <button class="btn" style="background:#ccc; margin-top:10px;" onclick="location.reload()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–ï–†–ï–•–í–ê–¢ –û–®–ò–ë–û–ö (–ß–¢–û–ë–´ –í–´ –í–ò–î–ï–õ–ò, –ï–°–õ–ò –ß–¢–û-–¢–û –°–õ–û–ú–ê–õ–û–°–¨)
        window.onerror = function(msg, url, line) {
            alert("–û–®–ò–ë–ö–ê –ö–û–î–ê:\n" + msg + "\n–°—Ç—Ä–æ–∫–∞: " + line);
            return false;
        };

        const tg = window.Telegram.WebApp;
        tg.expand();

        let myMap, multiRoute;
        let foundRoutes = [];
        let finalMessage = "";
        let activeInput = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã
        ymaps.ready(() => {
            myMap = new ymaps.Map('map', { center: [55.75, 37.62], zoom: 11, controls: [] });
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫ (OSM)
            setupOSM('inp-from');
            setupOSM('inp-to');
        }).catch(e => alert("–û—à–∏–±–∫–∞ –Ø–Ω–¥–µ–∫—Å–∞: " + e));

        // --- –ü–û–ò–°–ö –ë–ï–ó –ö–õ–Æ–ß–ï–ô (OSM) ---
        function setupOSM(id) {
            const el = document.getElementById(id);
            let timer;
            el.addEventListener('input', (e) => {
                activeInput = el;
                clearTimeout(timer);
                const val = e.target.value;
                if(val.length < 3) return;

                // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–∏—Å–∫–∞
                timer = setTimeout(() => {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val} –ú–æ—Å–∫–≤–∞&limit=5`)
                    .then(r => r.json())
                    .then(data => showSuggest(data))
                    .catch(e => console.log(e));
                }, 400);
            });
        }

        function showSuggest(items) {
            const list = document.getElementById('s-list');
            list.innerHTML = "";
            list.classList.add('active');

            if(items.length === 0) {
                list.innerHTML = "<div class='s-item'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>";
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 's-item';
                div.innerText = item.display_name.split(',')[0]; // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–∑–≤–∞–Ω–∏–µ)
                div.onclick = () => {
                    activeInput.value = item.display_name.split(',')[0];
                    list.classList.remove('active');
                };
                list.appendChild(div);
            });
        }

        // --- –ú–ê–†–®–†–£–¢–´ ---
        function runSearch() {
            const from = document.getElementById('inp-from').value;
            const to = document.getElementById('inp-to').value;
            if(!from || !to) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");

            if(multiRoute) myMap.geoObjects.remove(multiRoute);

            // –î–æ–±–∞–≤–ª—è–µ–º "–ú–æ—Å–∫–≤–∞" –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
            multiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: ["–ú–æ—Å–∫–≤–∞ " + from, "–ú–æ—Å–∫–≤–∞ " + to],
                params: { routingMode: 'masstransit', results: 3 } // –ü–†–û–°–ò–ú 3 –í–ê–†–ò–ê–ù–¢–ê
            }, {
                boundsAutoApply: true,
                routeActiveStrokeColor: "#007AFF"
            });

            myMap.geoObjects.add(multiRoute);

            multiRoute.model.events.add('requestsuccess', () => {
                foundRoutes = multiRoute.model.getRoutes();
                if(foundRoutes.length > 0) {
                    renderUI();
                } else {
                    alert("–Ø–Ω–¥–µ–∫—Å –Ω–µ –Ω–∞—à–µ–ª –º–∞—Ä—à—Ä—É—Ç :(");
                }
            });
            
            multiRoute.model.events.add('requestfail', (e) => alert("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: " + e.get('error').message));
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê –ò –í–´–ë–û–† ---
        function renderUI() {
            document.getElementById('view-search').style.display = 'none';
            document.getElementById('view-results').style.display = 'flex';
            
            const tabs = document.getElementById('tabs');
            tabs.innerHTML = "";

            // –†–∏—Å—É–µ–º —Ç–∞–±—ã –¥–ª—è –ö–ê–ñ–î–û–ì–û –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
            foundRoutes.forEach((route, index) => {
                const btn = document.createElement('div');
                btn.className = 'tab';
                btn.innerText = route.properties.get("duration").text;
                // –í–ê–ñ–ù–û: –ö–ª–∏–∫ –º–µ–Ω—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç
                btn.onclick = () => selectRoute(index);
                tabs.appendChild(btn);
            });

            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å—Ä–∞–∑—É
            selectRoute(0);
        }

        function selectRoute(index) {
            // 1. –ú–µ–Ω—è–µ–º –∫–∞—Ä—Ç—É
            multiRoute.setActiveRoute(index);

            // 2. –ö—Ä–∞—Å–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
            const allTabs = document.querySelectorAll('.tab');
            allTabs.forEach((t, i) => {
                if(i === index) t.classList.add('active');
                else t.classList.remove('active');
            });

            // 3. –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç
            parseDetails(foundRoutes[index]);
        }

        function parseDetails(route) {
            const list = document.getElementById('steps');
            list.innerHTML = "";
            let msg = `üèÅ –ú–∞—Ä—à—Ä—É—Ç: ${route.properties.get("duration").text}\n\n`;

            try {
                const paths = route.getPaths();
                paths.forEach(path => {
                    path.getSegments().forEach(seg => {
                        // –ß–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç –æ—Ç HTML —Ç–µ–≥–æ–≤
                        let text = seg.properties.get("text").replace(/<[^>]*>?/gm, '');
                        let icon = "üö∂";
                        
                        if(seg.properties.get("type") === "transport") {
                            icon = "üöå";
                            const tr = seg.properties.get("transports");
                            if(tr && tr[0] && tr[0].type === 'subway') icon = "üöá";
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                        list.innerHTML += `<div class="step"><b>${icon}</b> ${text}</div>`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –¢–ì
                        msg += `${icon} ${text}\n‚¨áÔ∏è\n`;
                    });
                });
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: " + e);
            }
            
            msg += "üèÅ –ü—Ä–∏–±—ã—Ç–∏–µ";
            finalMessage = msg;
        }

        function sendTg() {
            if(!finalMessage) return alert("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω!");
            tg.sendData(JSON.stringify({ text: finalMessage, action: 'save_details' }));
        }
        
        // –ö–ª–∏–∫ –º–∏–º–æ —Å–ø–∏—Å–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.input-row')) {
                document.getElementById('s-list').classList.remove('active');
            }
        });

    </script>
</body>
</html>
