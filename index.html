<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –í–∞–∂–Ω–æ: –∑–∞–ø—Ä–µ—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–ª—å—Ü–∞–º–∏, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ª–æ–º–∞–ª—Å—è -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –ú–∞—Ä—à—Ä—É—Ç</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®_API_–ö–õ–Æ–ß -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=8e8319a0-f355-4f5b-bef4-20745b37f5a1&lang=ru_RU&modules=services.Panel,suggest,multiRouter.MultiRoute,geolocation" type="text/javascript"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html { 
            padding: 0; margin: 0; width: 100%; height: 100%; 
            font-family: 'Roboto', sans-serif; 
            overflow: hidden; /* –ó–∞–ø—Ä–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            position: fixed; /* –§–∏–∫—Å–∞—Ü–∏—è –≤—Å–µ–≥–æ —ç–∫—Ä–∞–Ω–∞ */
        }
        
        #map { 
            width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; z-index: 1; 
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ (–ü–û–ò–°–ö) --- */
        .search-container {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 2000;
            padding: 12px;
            /* –£—á–µ—Ç "—á–µ–ª–∫–∏" —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Å—Ç–∞—Ç—É—Å –±–∞—Ä–∞ */
            padding-top: calc(12px + env(safe-area-inset-top)); 
            background: linear-gradient(to bottom, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ –º–∏–º–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç—É */
        }

        .search-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            pointer-events: auto; /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ */
            display: flex; 
            flex-direction: column; 
            gap: 12px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ */
        }

        /* –ì—Ä—É–ø–ø–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
        .input-wrapper {
            position: relative;
            width: 100%;
        }

        .input-icon {
            position: absolute;
            left: 14px; top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .custom-input {
            width: 100%;
            padding: 14px 14px 14px 40px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –ø–æ–¥ –∏–∫–æ–Ω–∫—É */
            border: 1px solid #E5E7EB;
            background: #F3F4F6;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ iOS */
        }
        
        .custom-input:focus {
            background: #fff;
            border-color: #E31E24;
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ì–¥–µ —è" –≤–Ω—É—Ç—Ä–∏ –∏–Ω–ø—É—Ç–∞ */
        .locate-btn {
            position: absolute; right: 10px; top: 50%;
            transform: translateY(-50%);
            background: #EBF5FF; color: #007AFF;
            border: none; border-radius: 8px;
            padding: 6px 10px; font-weight: 600; font-size: 12px;
            cursor: pointer;
        }

        .btn-main {
            background: #E31E24; color: white;
            border: none; padding: 14px;
            border-radius: 12px; font-weight: 600; font-size: 16px;
            cursor: pointer; text-align: center;
            width: 100%;
            box-shadow: 0 4px 10px rgba(227, 30, 36, 0.3);
        }
        .btn-main:active { opacity: 0.9; transform: scale(0.98); }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ (–†–ï–ó–£–õ–¨–¢–ê–¢–´) --- */
        .result-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom)); /* –£—á–µ—Ç –ø–æ–ª–æ—Å–∫–∏ home bar */
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            z-index: 2100;
            transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .result-sheet.active { transform: translateY(0); }

        .result-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        
        .time-big { font-size: 32px; font-weight: 800; color: #111827; letter-spacing: -1px; }
        .dist-small { font-size: 16px; color: #6B7280; font-weight: 500; }

        .btn-confirm {
            background: #111827; color: white;
            width: 100%; padding: 16px;
            border: none; border-radius: 14px;
            font-size: 16px; font-weight: 600;
            cursor: pointer;
        }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –Ø–Ω–¥–µ–∫—Å–∞, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        .ymaps-2-1-79-search__suggest { z-index: 9999 !important; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="search-container">
        <div class="search-card">
            <!-- –û—Ç–∫—É–¥–∞ -->
            <div class="input-wrapper">
                <span class="input-icon">üü¢</span>
                <input type="text" id="suggest-from" class="custom-input" placeholder="–û—Ç–∫—É–¥–∞?">
                <button class="locate-btn" onclick="findMe()">–ì–¥–µ —è</button>
            </div>
            
            <!-- –ö—É–¥–∞ -->
            <div class="input-wrapper">
                <span class="input-icon">üî¥</span>
                <input type="text" id="suggest-to" class="custom-input" placeholder="–ö—É–¥–∞?">
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
            <button class="btn-main" onclick="buildRoute()">–ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</button>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="result-sheet" id="result-panel">
        <div class="result-row">
            <div class="time-big" id="res-time">-- –º–∏–Ω</div>
            <div class="dist-small" id="res-dist">-- –∫–º</div>
        </div>
        <button class="btn-confirm" onclick="sendToBot()">–ü–æ–µ—Ö–∞–ª–∏! üöá</button>
    </div>

    <script type="text/javascript">
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        let myMap;
        let activeMultiRoute = null;
        let routeData = {};

        ymaps.ready(init);

        function init() {
            // –¶–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã
            myMap = new ymaps.Map('map', {
                center: [55.753215, 37.622504],
                zoom: 11,
                controls: [] 
            }, {
                zoomControlSize: 'small',
                zoomControlPosition: { right: 10, top: 200 } // –°–¥–≤–∏–≥–∞–µ–º –∑—É–º, –µ—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω
            });

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
            var suggestView1 = new ymaps.SuggestView('suggest-from', { results: 3, offset: [0, 5] });
            var suggestView2 = new ymaps.SuggestView('suggest-to', { results: 3, offset: [0, 5] });
        }

        function buildRoute() {
            const from = document.getElementById('suggest-from').value;
            const to = document.getElementById('suggest-to').value;

            if(!from || !to) {
                tg.HapticFeedback.notificationOccurred('error');
                return; 
            }

            if (activeMultiRoute) {
                myMap.geoObjects.remove(activeMultiRoute);
            }

            // –õ–æ–∞–¥–µ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ (–≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
            let btn = document.querySelector('.btn-main');
            let oldText = btn.innerText;
            btn.innerText = "–ò—â–µ–º...";

            activeMultiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [from, to],
                params: { routingMode: 'masstransit' }
            }, {
                routeStrokeColor: "#E31E24", 
                routeActiveStrokeColor: "#E31E24",
                routeStrokeWidth: 5,
                boundsAutoApply: true 
            });

            myMap.geoObjects.add(activeMultiRoute);

            activeMultiRoute.model.events.add('requestsuccess', function() {
                btn.innerText = oldText;
                const activeRoute = activeMultiRoute.getActiveRoute();
                if (activeRoute) {
                    const time = activeRoute.properties.get("duration").text;
                    const dist = activeRoute.properties.get("distance").text;
                    
                    document.getElementById('res-time').innerText = time;
                    document.getElementById('res-dist').innerText = dist;
                    document.getElementById('result-panel').classList.add('active');
                    
                    routeData = { time: time, distance: dist };
                    tg.HapticFeedback.notificationOccurred('success');
                }
            });
            
            activeMultiRoute.model.events.add('requestfail', function() {
                btn.innerText = oldText;
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç");
            });
        }

        function findMe() {
            ymaps.geolocation.get({ provider: 'browser' }).then(function (res) {
                const userAddress = res.geoObjects.get(0).properties.get('text');
                document.getElementById('suggest-from').value = userAddress;
                tg.HapticFeedback.impactOccurred('light');
            });
        }

        function sendToBot() {
            if(routeData.time) {
                tg.sendData(JSON.stringify({...routeData, action: 'save_route'}));
            }
        }
    </script>
</body>
</html>
