<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Moscow Social Move</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ü–†–û–í–ï–†–¨–¢–ï, –ß–¢–û –í–ê–® –ö–õ–Æ–ß –†–ê–ë–û–ß–ò–ô -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=8e8319a0-f355-4f5b-bef4-20745b37f5a1&lang=ru_RU&modules=services.Panel,suggest,multiRouter.MultiRoute,geolocation" type="text/javascript"></script>
    
    <style>
        /* --- APPLE SYSTEM DESIGN --- */
        :root {
            --bg-blur: rgba(255, 255, 255, 0.9);
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --accent: #007AFF; /* Apple Blue */
            --danger: #FF3B30;
            --input-bg: rgba(118, 118, 128, 0.12); /* –°–µ—Ä—ã–π —Ñ–æ–Ω –∏–Ω–ø—É—Ç–æ–≤ iOS */
            --radius: 20px;
            --shadow: 0 4px 24px rgba(0,0,0,0.1);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fff; }

        /* –ö–ê–†–¢–ê */
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ü–õ–ê–í–ê–Æ–©–ê–Ø –ö–ê–†–¢–û–ß–ö–ê (SHEET) --- */
        /* –ö–∞–∫ –≤ Apple Maps - –ø–æ–∏—Å–∫ —Å–Ω–∏–∑—É */
        .sheet-container {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 5000;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ */
        }

        .glass-panel {
            background: var(--bg-blur);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-radius: var(--radius);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            padding: 20px;
            pointer-events: auto; /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .inputs-block {
            display: flex; flex-direction: column; gap: 12px;
        }

        .input-row {
            position: relative;
            background: var(--input-bg);
            border-radius: 12px;
            height: 44px; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç iOS */
            display: flex; align-items: center;
            padding: 0 12px;
            transition: 0.2s;
        }
        .input-row:focus-within { background: #fff; box-shadow: 0 0 0 2px var(--accent); }

        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .green { background: #34C759; }
        .red { background: #FF3B30; }

        .native-input {
            flex: 1; border: none; background: transparent;
            font-size: 17px; color: var(--text-primary);
            height: 100%; outline: none;
        }
        .native-input::placeholder { color: var(--text-secondary); }

        .icon-btn {
            background: none; border: none; padding: 8px;
            color: var(--accent); cursor: pointer; display: flex;
        }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è */
        .action-btn {
            margin-top: 16px;
            width: 100%; height: 50px;
            background: var(--accent); color: white;
            border: none; border-radius: 14px;
            font-size: 17px; font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.98); opacity: 0.9; }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞ (–°–∫—Ä—ã—Ç—ã) */
        .route-result {
            display: none;
            flex-direction: column; gap: 5px; margin-bottom: 15px;
        }
        .route-result.show { display: flex; }
        
        .time-display { font-size: 32px; font-weight: 700; color: #000; letter-spacing: -0.5px; }
        .details-display { font-size: 15px; color: var(--text-secondary); }

        /* --- FAKE SUGGEST STYLING --- */
        /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∏–ª–∏–∑—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –Ø–Ω–¥–µ–∫—Å–∞ */
        .ymaps-2-1-79-search__suggest {
            border-radius: 12px !important;
            border: none !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
            margin-bottom: 10px !important; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —Ç.–∫. –ø–∞–Ω–µ–ª—å —Å–Ω–∏–∑—É */
            z-index: 99999 !important; /* –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –ü–û–í–ï–†–• –í–°–ï–ì–û */
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
        }
        .ymaps-2-1-79-search__suggest-item {
            padding: 10px 12px !important;
            font-size: 16px !important;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        .spinner {
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="sheet-container">
        <div class="glass-panel">
            
            <!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞) -->
            <div class="route-result" id="route-info">
                <div class="time-display" id="r-time">-- –º–∏–Ω</div>
                <div class="details-display" id="r-dist">–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω</div>
            </div>

            <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ -->
            <div class="inputs-block" id="input-area">
                <div class="input-row">
                    <div class="dot green"></div>
                    <!-- ID –≤–∞–∂–Ω—ã –¥–ª—è –Ø–Ω–¥–µ–∫—Å–∞ -->
                    <input type="text" id="suggest-from" class="native-input" placeholder="–û—Ç–∫—É–¥–∞?">
                    <button class="icon-btn" onclick="findMe()">
                        <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg>
                    </button>
                </div>
                <div class="input-row">
                    <div class="dot red"></div>
                    <input type="text" id="suggest-to" class="native-input" placeholder="–ö—É–¥–∞?">
                </div>
            </div>

            <button class="action-btn" id="main-btn" onclick="handleBtn()">
                <span id="btn-text">–ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</span>
                <div class="spinner" id="btn-loader"></div>
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let myMap, activeRoute;
        let mode = 'search'; // 'search' –∏–ª–∏ 'result'
        let routeData = {};

        ymaps.ready(init);

        function init() {
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            myMap = new ymaps.Map('map', {
                center: [55.753215, 37.622504],
                zoom: 11,
                controls: [] // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ø–Ω–¥–µ–∫—Å–∞, —É –Ω–∞—Å —Å–≤–æ–π UI
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–°–∞–¥–∂–µ—Å—Ç—ã)
            // offset –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–ª—Å—è –í–í–ï–†–•, —Ç–∞–∫ –∫–∞–∫ –ø–∞–Ω–µ–ª—å –≤–Ω–∏–∑—É
            const s1 = new ymaps.SuggestView('suggest-from', { results: 3, offset: [0, -200] });
            const s2 = new ymaps.SuggestView('suggest-to', { results: 3, offset: [0, -200] });
            
            // –§–∏–∫—Å –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –Ω–∞–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            // (–Ø–Ω–¥–µ–∫—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∏—Ö –≤–Ω–∏–∑, —á—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ –ø—Ä–∏ –¥–∏–∑–∞–π–Ω–µ —Å–Ω–∏–∑—É)
        }

        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏
        function handleBtn() {
            if (mode === 'search') {
                buildRoute();
            } else {
                sendData();
            }
        }

        function buildRoute() {
            const from = document.getElementById('suggest-from').value;
            const to = document.getElementById('suggest-to').value;

            if(!from || !to) {
                tg.HapticFeedback.notificationOccurred('error');
                // –í–∏–∑—É–∞–ª—å–Ω–æ —Ç—Ä—è—Å–µ–º –∏–Ω–ø—É—Ç—ã (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å CSS –∞–Ω–∏–º–∞—Ü–∏—é)
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            setLoading(true);

            if (activeRoute) myMap.geoObjects.remove(activeRoute);

            activeRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [from, to],
                params: { routingMode: 'masstransit' }
            }, {
                routeStrokeColor: "#007AFF", 
                routeActiveStrokeColor: "#007AFF",
                routeStrokeWidth: 5,
                boundsAutoApply: true 
            });

            myMap.geoObjects.add(activeRoute);

            // –£—Å–ø–µ—Ö
            activeRoute.model.events.add('requestsuccess', function() {
                setLoading(false);
                const route = activeRoute.getActiveRoute();
                if(route) {
                    const time = route.properties.get("duration").text;
                    const dist = route.properties.get("distance").text;
                    
                    // –ú–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ "–†–µ–∑—É–ª—å—Ç–∞—Ç"
                    document.getElementById('input-area').style.display = 'none'; // –ü—Ä—è—á–µ–º –∏–Ω–ø—É—Ç—ã
                    document.getElementById('route-info').classList.add('show'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—ã
                    
                    document.getElementById('r-time').innerText = time;
                    document.getElementById('r-dist').innerText = dist;
                    
                    document.getElementById('btn-text').innerText = "–ü–æ–µ—Ö–∞–ª–∏ üöÄ";
                    document.getElementById('main-btn').style.background = "#000"; // –ß–µ—Ä–Ω–∞—è –∫–Ω–æ–ø–∫–∞
                    
                    mode = 'result';
                    routeData = { time, dist };
                    tg.HapticFeedback.notificationOccurred('success');
                }
            });

            // –û—à–∏–±–∫–∞
            activeRoute.model.events.add('requestfail', function() {
                setLoading(false);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å–∞.");
            });
        }

        function setLoading(isLoading) {
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            if(isLoading) {
                btnText.style.display = 'none';
                loader.style.display = 'block';
            } else {
                btnText.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        function findMe() {
            tg.HapticFeedback.impactOccurred('light');
            ymaps.geolocation.get({ provider: 'browser' }).then(res => {
                const address = res.geoObjects.get(0).properties.get('text');
                document.getElementById('suggest-from').value = address || "–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
            }).catch(e => {
                alert("–í–∫–ª—é—á–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è Telegram –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞!");
            });
        }

        function sendData() {
            tg.sendData(JSON.stringify({...routeData, action: 'save_route'}));
        }
    </script>
</body>
</html>
