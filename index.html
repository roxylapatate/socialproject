<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moscow Social Mobility</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=8e8319a0-f355-4f5b-bef4-20745b37f5a1&lang=ru_RU" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #E31E24;
            --success: #27AE60; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —ç–∫–æ–ª–æ–≥–∏–∏ */
            --surface: #ffffff;
            --text: #1F2937;
            --secondary-text: #6B7280;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        body.dark-mode {
            --surface: #1F1F1F;
            --text: #F3F4F6;
            --secondary-text: #9CA3AF;
        }

        body, html { padding: 0; margin: 0; width: 100%; height: 100%; font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–Ø–∑—ã–∫ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å) */
        .top-bar {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            display: flex; gap: 8px;
        }
        .icon-btn {
            background: var(--surface); border: none; padding: 10px;
            border-radius: 50%; box-shadow: var(--shadow);
            cursor: pointer; font-size: 18px; color: var(--text);
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 20px; z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transform: translateY(0); transition: transform 0.3s;
        }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-top: 15px; display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ */
        }

        .stat-card {
            background: rgba(0,0,0,0.05); padding: 12px; border-radius: 12px;
            text-align: center;
        }
        .dark-mode .stat-card { background: rgba(255,255,255,0.1); }

        .stat-value { font-weight: 700; font-size: 16px; display: block; }
        .stat-label { font-size: 11px; color: var(--secondary-text); }
        .eco { color: var(--success); }

        .btn-main {
            width: 100%; background: var(--primary); color: white;
            border: none; padding: 14px; border-radius: 12px;
            font-weight: 600; font-size: 16px; margin-top: 15px;
            cursor: pointer; display: none;
        }

        .category-scroll {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px;
        }
        .cat-chip {
            background: var(--surface); border: 1px solid #e5e7eb;
            padding: 8px 14px; border-radius: 20px; font-size: 13px;
            white-space: nowrap; cursor: pointer; color: var(--text);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ -->
    <div class="top-bar">
        <button class="icon-btn" onclick="toggleLang()">üåê <span id="lang-ind">RU</span></button>
        <button class="icon-btn" id="access-btn" onclick="toggleAccess()">‚ôø</button>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="bottom-sheet">
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ -->
        <div class="category-scroll">
            <button class="cat-chip" onclick="search('–ú–§–¶')">üè¢ <span data-t="mfc">–ú–§–¶</span></button>
            <button class="cat-chip" onclick="search('–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞')">üè• <span data-t="clinic">–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏</span></button>
            <button class="cat-chip" onclick="search('–ü–∞–Ω–¥—É—Å')">‚ôø <span data-t="ramps">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</span></button>
            <button class="cat-chip" onclick="findMe()">üìç <span data-t="me">–ì–¥–µ —è</span></button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≠–∫–æ–ª–æ–≥–∏—è) -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <span class="stat-value eco" id="co2-val">0 g</span>
                <span class="stat-label" data-t="co2_saved">CO‚ÇÇ Saved</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="cal-val">0</span>
                <span class="stat-label" data-t="cal_burn">Calories</span>
            </div>
        </div>

        <button class="btn-main" id="send-btn" onclick="sendData()">
            <span data-t="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        if(tg.colorScheme === 'dark') document.body.classList.add('dark-mode');

        // –¢–µ–∫—Å—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        const texts = {
            ru: { mfc: "–ú–§–¶", clinic: "–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏", ramps: "–ü–∞–Ω–¥—É—Å—ã", me: "–ì–¥–µ —è", co2_saved: "–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ CO‚ÇÇ", cal_burn: "–ö–∫–∞–ª —Å–æ–∂–∂–µ–Ω–æ", send: "‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫—É" },
            en: { mfc: "Public Services", clinic: "Hospitals", ramps: "Ramps", me: "Where am I", co2_saved: "CO‚ÇÇ Saved", cal_burn: "Calories burned", send: "‚úÖ Save Trip" }
        };

        let lang = 'ru';
        let accessibilityMode = false;
        let routeData = {};

        function toggleLang() {
            lang = lang === 'ru' ? 'en' : 'ru';
            document.getElementById('lang-ind').innerText = lang.toUpperCase();
            updateTexts();
        }

        function toggleAccess() {
            accessibilityMode = !accessibilityMode;
            const btn = document.getElementById('access-btn');
            btn.style.background = accessibilityMode ? '#E31E24' : 'var(--surface)';
            btn.style.color = accessibilityMode ? '#fff' : 'var(--text)';
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ API –ø–æ–∑–≤–æ–ª—è–µ—Ç,
            // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ —É–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            tg.HapticFeedback.notificationOccurred('warning');
        }

        function updateTexts() {
            document.querySelectorAll('[data-t]').forEach(el => {
                el.innerText = texts[lang][el.getAttribute('data-t')];
            });
        }

        // --- –ö–ê–†–¢–ê ---
        let myMap, routePanelControl;

        ymaps.ready(function(){
            myMap = new ymaps.Map("map", {
                center: [55.751574, 37.573856], zoom: 11, controls: []
            });

            routePanelControl = new ymaps.control.RoutePanel({
                options: { showHeader: true, maxWidth: '280px', visible: true }
            });
            
            routePanelControl.routePanel.state.set({
                type: 'masstransit', fromEnabled: true, toEnabled: true
            });

            myMap.controls.add(routePanelControl, {float: 'top', right: 10});

            // –°–ª—É—à–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —ç–∫–æ-—Å–ª–µ–¥–∞
            routePanelControl.routePanel.getRouteAsync().then(function (route) {
                route.model.events.add('requestsuccess', function () {
                    const activeRoute = route.getActiveRoute();
                    if(activeRoute) {
                        const distanceMeters = activeRoute.properties.get("distance").value;
                        const timeText = activeRoute.properties.get("duration").text;
                        
                        calculateEcoImpact(distanceMeters);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        routeData = {
                            time: timeText,
                            dist: activeRoute.properties.get("distance").text,
                            co2: document.getElementById('co2-val').innerText,
                            cal: document.getElementById('cal-val').innerText
                        };
                        
                        document.getElementById('stats').style.display = 'grid';
                        document.getElementById('send-btn').style.display = 'block';
                    }
                });
            });
        });

        // –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ —ç–∫–æ–ª–æ–≥–∏–∏ (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è)
        function calculateEcoImpact(meters) {
            const km = meters / 1000;
            // 1 –∫–º –Ω–∞ –∞–≤—Ç–æ ~ 150–≥ CO2. –ù–∞ –º–µ—Ç—Ä–æ —Å—á–∏—Ç–∞–µ–º ~ 0 (—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è –ê–≠–°/–ì–≠–°)
            const savedCO2 = Math.round(km * 150); 
            // –ö–∞–ª–æ—Ä–∏–∏: —Ö–æ–¥—å–±–∞ –∏ –ø–µ—Ä–µ—Å–∞–¥–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ 20% –æ—Ç –ø—É—Ç–∏ –ø–µ—à–∫–æ–º)
            const calories = Math.round(km * 0.2 * 50); 

            document.getElementById('co2-val').innerText = `${savedCO2} g`;
            document.getElementById('cal-val').innerText = `${calories} kcal`;
        }

        function search(query) {
            const searchControl = new ymaps.control.SearchControl({
                options: { provider: 'yandex#search', results: 5 }
            });
            myMap.controls.add(searchControl);
            searchControl.search(query);
        }

        function findMe() {
            ymaps.geolocation.get({ provider: 'browser', mapStateAutoApply: true })
            .then(res => {
                routePanelControl.routePanel.state.set({
                    from: res.geoObjects.get(0).geometry.getCoordinates()
                });
            });
        }

        function sendData() {
            tg.sendData(JSON.stringify({...routeData, action: 'save_route'}));
        }
    </script>
</body>
</html>
